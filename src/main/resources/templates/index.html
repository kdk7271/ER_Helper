
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Search</title>
    <!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© CSS ì¶”ê°€ -->
    <script type="text/javascript" th:src="|https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=${mapId}&submodules=geocoder|"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">
<!-- ë„¤ë¹„ -->
<nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">AIVLE SCHOOL 20ì¡°</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="#">Login</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" th:href="@{/admintest}">Admin</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Link</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Dropdown
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#">Action</a></li>
                        <li><a class="dropdown-item" href="#">Another action</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#">Something else here</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link disabled" aria-disabled="true">Disabled</a>
                </li>
            </ul>
            <form class="d-flex" role="search">
                <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
                <button class="btn btn-outline-success" type="submit">Search</button>
            </form>
        </div>
    </div>
</nav>
<!-- ë³¸ë¬¸ -->

<!--
<div class="container my-5">
    <h1 class="text-center text-primary mb-4">Hospital Search</h1>

    <div class="card p-4 shadow-sm">
        <form action="recommend_hospital" enctype="application/x-www-form-urlencoded">
            <div class="mb-3">
                <label for="request" class="form-label">ì‚¬ê±´ ë‚´ìš©</label>
                <div class="d-flex align-items-center">
                    <input type="text" id="request" name="request" class="form-control me-2" placeholder="ìƒí™©ì„ ì…ë ¥í•˜ì„¸ìš”">
                    <button type="button" onclick="startRecord()" class="btn btn-outline-primary me-1">âºï¸</button>
                    <button type="button" onclick="endRecord()" class="btn btn-outline-danger">ğŸ›‘</button>
                </div>
            </div>

            <div class="mb-3">
                <label for="latitude" class="form-label">ìœ„ë„</label>
                <input type="text" id="latitude" name="latitude" class="form-control" placeholder="ìœ„ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>

            <div class="mb-3">
                <label for="longitude" class="form-label">ê²½ë„</label>
                <input type="text" id="longitude" name="longitude" class="form-control" placeholder="ê²½ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg">ì¶”ì²œ ë³‘ì› ê²€ìƒ‰</button>
            </div>
        </form>
    </div>
</div>
-->

<div class="container mt-5">
    <div class="card">
        <div class="card-header">
            <h1 class="card-title">ì‘ê¸‰ì‹¤ ê²€ìƒ‰</h1>
        </div>
        <div class="card-body">
            <form id="inputForm" action="/recommend_hospital" method="post">
                <!-- Text Input -->
                <div class="mb-3">
                    <label for="request" class="form-label">ì‚¬ê±´ ë‚´ìš©</label>
                    <div class="d-flex align-items-center">
                        <input type="text" id="request" name="request" class="form-control me-2" placeholder="ìƒí™©ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                        <button type="button" onclick="startRecord()" class="btn btn-outline-primary me-1">âºï¸</button>
                        <button type="button" onclick="endRecord()" class="btn btn-outline-danger">ğŸ›‘</button>
                    </div>
                </div>

                <!-- Coordinates Input -->
                <div class="mb-3">
                    <div class="input-group">
                        <input id="latitude" name="latitude" type="number" step="any" class="form-control"
                               placeholder="ìœ„ë„" value="37.538435245262626" readonly>
                        <input id="longitude" name="longitude" type="number" step="any" class="form-control"
                               placeholder="ê²½ë„" value="126.98982802695484" readonly>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="input-group">
                        <input id="count" name="count" type="number" step="1" class="form-control"
                               placeholder="ì‘ê¸‰ì‹¤" value="3" required>
                    </div>
                </div>
                

                <!-- Map Display -->
                <div class="mb-3">
                    <label for="map" class="form-label">Map</label>
                    <div id="map" style="width: 100%; height: 300px; background-color: #e9ecef;"></div>
                </div>

                <!-- Geocode ë¯¸ì§€ì›ì‹œ ì£¼ì†Œê²€ìƒ‰ -->
                <div class="mb-3 d-flex">
                    <input id="address" type="text" class="form-control me-2" placeholder="ì§€ë²ˆ/ë„ë¡œëª…ì„ ì…ë ¥í•˜ì„¸ìš”" hidden>
                    <button id="search" type="button" class="btn btn-outline-primary me-1 col-2" hidden>ì£¼ì†Œ ê²€ìƒ‰</button>
                </div>

                <!-- Submit Button -->
                <button class="btn btn-primary w-100" type="submit">Submit</button>
            </form>
        </div>
    </div>
</div>
<!-- ë¶€íŠ¸ìŠ¤íŠ¸ë© JS ì¶”ê°€ -->
<script>

    // ìŒì„±ì¸ì‹
    const searchConsole = document.getElementById("request");

    // ----- í˜„ì¬ ë¸Œë¼ìš°ì €ì—ì„œ API ì‚¬ìš©ì´ ìœ íš¨í•œê°€ë¥¼ ê²€ì¦
    function availabilityFunc() {
        //í˜„ì¬ SpeechRecognitionì„ ì§€ì›í•˜ëŠ” í¬ë¡¬ ë²„ì „ê³¼ webkit í˜•íƒœë¡œ ì œê³µë˜ëŠ” ë²„ì „ì´ ìˆìœ¼ë¯€ë¡œ ë‘˜ ì¤‘ í•´ë‹¹í•˜ëŠ” ìƒì„±ìë¥¼ í˜¸ì¶œí•œë‹¤.
        recognition = new webkitSpeechRecognition() || new SpeechRecognition();
        recognition.lang = "ko"; // ìŒì„±ì¸ì‹ì— ì‚¬ìš©ë˜ê³  ë°˜í™˜ë  ì–¸ì–´ë¥¼ ì„¤ì •í•œë‹¤.
        recognition.maxAlternatives = 5; //ìŒì„± ì¸ì‹ê²°ê³¼ë¥¼ 5ê°œ ê¹Œì§€ ë³´ì—¬ì¤€ë‹¤.
        recognition.interimResults = true; // ì¤‘ê°„ ê²°ê³¼ë¥¼ ë°˜í™˜í•˜ë„ë¡ ì„¤ì • (ì„ íƒ ì‚¬í•­)

        if (!recognition) {
            alert("í˜„ì¬ ë¸Œë¼ìš°ì €ëŠ” ì‚¬ìš©ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }
    }

    // --- ìŒì„±ë…¹ìŒì„ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜
    function startRecord() {
        console.log("ì‹œì‘");

        // âºï¸í´ë¦­ ì‹œ ìŒì„±ì¸ì‹ì„ ì‹œì‘í•œë‹¤.
        recognition.addEventListener("speechstart", () => {
            console.log("ì¸ì‹");
        });

        //ìŒì„±ì¸ì‹ì´ ëê¹Œì§€ ì´ë£¨ì–´ì§€ë©´ ì¤‘ë‹¨ëœë‹¤.
        recognition.addEventListener("speechend", () => {
            console.log("ì¸ì‹2");
        });

        //ìŒì„±ì¸ì‹ ê²°ê³¼ë¥¼ ë°˜í™˜
        // SpeechRecognitionResult ì— ë‹´ê²¨ì„œ ë°˜í™˜ëœë‹¤.
        recognition.addEventListener("result", (e) => {
            searchConsole.value = e.results[0][0].transcript;
        });

        recognition.start();
    }
    //  ğŸ›‘ í´ë¦­ ì‹œ ì¢…ë£Œ(ì•ˆ ëˆŒëŸ¬ë„ ìŒì„±ì¸ì‹ì€ ì•Œì•„ì„œ ì¢…ë£Œë¨)
    function endRecord() {
        console.log("ì¢…ë£Œ");
        recognition.stop(); // ìŒì„±ì¸ì‹ì„ ì¤‘ë‹¨í•˜ê³  ì¤‘ë‹¨ê¹Œì§€ì˜ ê²°ê³¼ë¥¼ ë°˜í™˜
    }

    window.addEventListener("load", availabilityFunc);
    //ìŒì„±ì¸ì‹ ë


    //ì§€ë„
    var map
    var maker
    navigator.geolocation.getCurrentPosition(function (position) {
            var latitude = position.coords.latitude;  // ìœ„ë„
            var longitude = position.coords.longitude;  // ê²½ë„
            console.log("ìœ„ë„: " + latitude);
            console.log("ê²½ë„: " + longitude);

            // ìœ„ì¹˜ ì •ë³´ë¥¼ ë°›ì•„ì˜¨ í›„ input formì— ìœ„ë„, ê²½ë„ ê°’ ì„¤ì •
            document.getElementById('latitude').value = latitude;
            document.getElementById('longitude').value = longitude;

            // ê°€ì ¸ì˜¨ ì¢Œí‘œë¡œ ì§€ë„ ì´ˆê¸°í™”
            initMap(latitude, longitude)

        }, function (error) {
            console.error("ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
            var latitude = document.getElementById("latitude").value;
            var longitude = document.getElementById("longitude").value;

            // // ê²€ìƒ‰ì°½ í‘œì‹œ
            document.getElementById("address").hidden = false;
            document.getElementById("search").hidden = false;

            // ê¸°ë³¸ê°’ìœ¼ë¡œ ì§€ë„ ì´ˆê¸°í™”
            var init = initMap(latitude, longitude)
            map = init[0]
            marker = init[1]
            






        });
    
    // ì¹´ì¹´ì˜¤ ì£¼ì†Œê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById("address").addEventListener("click", function () { //ì£¼ì†Œì…ë ¥ì¹¸ì„ í´ë¦­í•˜ë©´
        new daum.Postcode({
            oncomplete: function (data) { //ì„ íƒì‹œ ì…ë ¥ê°’ ì„¸íŒ…
                document.getElementById("address").value = data.address; // ì£¼ì†Œ ë„£ê¸°
                document.querySelector("input[name=address_detail]");
            }
        }).open();
    });

    // ì£¼ì†Œë¡œ ì¢Œí‘œê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    document.getElementById('search').addEventListener('click', function (e) {
        e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€

        searchAddressToCoordinate(document.getElementById('address').value);
    });

    // ì£¼ì†Œë¡œ ì¢Œí‘œ ê²€ìƒ‰
    function searchAddressToCoordinate(address) {
        naver.maps.Service.geocode({
            query: address
        }, function(status, response) {
            if (status === naver.maps.Service.Status.ERROR) {
                return alert('Something Wrong!');
            }

            if (response.v2.meta.totalCount === 0) {
                return alert('totalCount' + response.v2.meta.totalCount);
            }

            var htmlAddresses = [],
                item = response.v2.addresses[0],
                point = new naver.maps.Point(item.x, item.y);

            if (item.roadAddress) {
                htmlAddresses.push('[ë„ë¡œëª… ì£¼ì†Œ] ' + item.roadAddress);
            }

            if (item.jibunAddress) {
                htmlAddresses.push('[ì§€ë²ˆ ì£¼ì†Œ] ' + item.jibunAddress);
            }

            if (item.englishAddress) {
                htmlAddresses.push('[ì˜ë¬¸ëª… ì£¼ì†Œ] ' + item.englishAddress);
            }

            map.setCenter(point);
            marker.setPosition(point);
            // infoWindow.open(map, point);
            });
    }

    // ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
    function initMap(lati, longi) {
        // ì§€ë„ ì˜µì…˜
        var mapOptions = {
            center: new naver.maps.LatLng(lati, longi),
            zoom: 19,
            zoomControl: true,
            zoomControlOptions: {
                position: naver.maps.Position.TOP_RIGHT
            }
        };
        var map = new naver.maps.Map('map', mapOptions);

        // ì§€ë„ ì¤‘ì‹¬ì— ë§ì¶° ë§ˆì»¤ë¥¼ ìƒì„±
        var marker = new naver.maps.Marker({
            position: map.getCenter(),
            map: map,
            draggable: false // ë§ˆì»¤ë¥¼ ë“œë˜ê·¸í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
        });

        // ì§€ë„ ì¤‘ì‹¬ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ ë§ˆì»¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        naver.maps.Event.addListener(map, 'center_changed', function () {
            var newCenter = map.getCenter();
            marker.setPosition(newCenter);

            // ìƒˆ ì¢Œí‘œë¡œ input í•„ë“œ ì—…ë°ì´íŠ¸
            document.getElementById('latitude').value = newCenter.lat();
            document.getElementById('longitude').value = newCenter.lng();
        });

        return [map, marker]
    }
    // ì§€ë„ ë
</script>
</body>
</html>
